/***************
 * Doppelganger
 * Copyright Atlassian 2014
 * Released under the Apache 2 license. http://www.apache.org/licenses/LICENSE-2.0.html
 */
(function(t){"use strict";function e(t){var e=[];return t?(o.each(t,function(t,r){var n,a=r.split(" "),i=a[0].split(","),s=a.slice(1).join(" "),u=t;o.each(i,function(r){"statechange"===r?(n=window,t=function(){var t=History.getState().data.query;u(t)},o.addEvent(n,r,t)):(n=l,o.addEvent(n,r,s,t)),e.push({name:r,selector:s,callback:t,elem:n})})}),e):e}function r(t){0!==t.length&&o.each(t,function(t){o.removeEvent(t.elem,t.name,t.selector,t.callback)})}var n;n=function(){this.routes={},this.filters={}},"object"==typeof module&&"object"==typeof module.exports?module.exports=n:t.Doppelganger=n;var a,i,o,s,l=t.document||{},u=Array.prototype,c=u.slice,f=u.isArray,h=u.forEach,d=u.indexOf,g={};n.util=o={getterSetterCreator:function(t){return function(e,r){var n=this[t];return r?(n[e]=r,void 0):n[e]}},extend:function(t){var e,r,n,a=c.call(arguments,1);for(r=0;a.length>r;r++)if(e=a[r])for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},each:function(t,e,r){if(null!=t)if(h&&t.forEach===h)t.forEach(e,r);else if(t.length===+t.length){for(var n=0,a=t.length;a>n;n++)if(e.call(r,t[n],n,t)===!1)return}else for(var i in t)if(t.hasOwnProperty(i)&&e(t[i],i,t)===!1)break},isArray:f||function(t){return t&&"object"==typeof t&&"number"==typeof t.length&&"[object Array]"==""+t||!1},indexOf:function(t,e){if(null==t)return-1;var r=0,n=t.length;if(d&&t.indexOf===d)return t.indexOf(e);for(;n>r;r++)if(t[r]===e)return r;return-1},map:function(t,e){var r=-1,n=t?t.length:0,a=Array("number"==typeof n?n:0);if(o.isArray(t))for(;n>++r;)a[r]=e(t[r],r,t);else o.each(t,function(t,n,i){a[++r]=e(t,n,i)});return a},$:function(t){return l.querySelectorAll(t)},matchesSelector:function(t,e){var r,n;if(t.matches)return t.matches(e);if(!t.parentNode){if(t===l)return"document"===e;r=l.createDocumentFragment(),r.appendChild(t)}n=t.parentNode.querySelectorAll(e);for(var a=0,i=n.length;i>a;a++)if(n[a]===t)return!0;return!1},closest:function(t,e){for(var r=t,n=!1;null!=r&&!(n=o.matchesSelector(r,e));)r=r.parentNode;return n},addEvent:function(t,e,r,n){var a=n;if(n=n?function(t){var e=t.target||t.srcElement;o.closest(e,r)&&a.apply(this,arguments)}:r,t.addEventListener)t.addEventListener(e,n,!1);else{if(!t.attachEvent)throw Error("addEvent() was called in a context without event listener support");t.attachEvent("on"+e,n)}g[e]||(g[e]=[]),g[e].push({fn:a,boundFn:n,selector:"string"==typeof r?r:""})},removeEvent:function(t,e,r,n){for(var a,i,o=g[e],s=o?o.length:0,l=0;s>l;l++)if(a=o[l],n===a.fn&&r===a.selector){i=a.boundFn,o.splice(l,1);break}if(i)if(t.removeEventListener)t.removeEventListener(e,i);else{if(!t.detachEvent)throw Error("removeEvent() was called in a context without event listener support");t.detachEvent(e,i)}}},s=o.$;var p={rootUrl:"",routes:[{name:"index",url:""}],filters:["RouterFilter","EventFilter"]},v={routes:"routeManager",filters:"filterManager"};n.create=function(t){var e,r,a=new n;a.options=o.extend({},p,t),a.filterManager=new n.FilterManager(a),a.routeManager=new n.RouteManager(a,a.options.rootUrl);for(var i in v)v.hasOwnProperty(i)&&(e=v[i],r=a.options[i],a[e].add(r));return a.options.urlCoerceMode===!1&&(Arg.coerceMode=!1),a},n.prototype={init:function(){var t=this;this.active=!0,History.Adapter.bind(window,"statechange",function(){var e=History.getState();t.active&&!e.data.controllerStateChange&&(e.data.destination?t.trigger(e.data.destination,e.data.params):e.data.destination||t.trigger(t.startPage.destination,t.startPage.params))}),this.startPage=this.routeManager.recognize(window.location.pathname+window.location.search),this.navigate()},_destroy:function(){this.active=!1},navigate:function(){this.navigate=function(t,e){e.replace?(delete e.replace,this._replace(t,e)):this._push(t,e)},this.startPage?this.trigger(this.startPage.destination,this.startPage.params):this.navigateDefault()},navigateDefault:function(){var t=this.options.defaultRoute[0],e=this.options.defaultRoute[1];this._replace(t,e)},trigger:function(t,e){this.filterManager.process({destination:t,params:e})},updateContent:function(t){var e=s(this.PAGE_CONTENT_SELECTOR);return e.append(t)},_push:function(e,r){history.pushState?History.pushState({destination:e,params:r},l.title,this.routeManager.generate(e,r)):t.location=this.routeManager.generate(e,r)},_replace:function(e,r){history.replaceState?History.replaceState({destination:e,params:r},l.title,this.routeManager.generate(e,r)):t.location=this.routeManager.generate(e,r)}},n.RouteHandlers={},n.setRouteHandler=o.getterSetterCreator("RouteHandlers"),n.getRouteHandler=o.getterSetterCreator("RouteHandlers"),n.FilterHandlers={},n.setFilterHandler=o.getterSetterCreator("FilterHandlers"),n.getFilterHandler=o.getterSetterCreator("FilterHandlers"),n.RouteManager=i=function(t,e){this.app=t,this.router=new Sherpa.Router,this.baseUrl=e,this.routes=[]},n.RouteManager.prototype={add:function(t){for(var e,r,n,a=t.length,i=0;a>i;i++)e=t[i],r=e.name,n=e.url,this.router.add(this.baseUrl+n,e).to(r).name(r);this.routes=this.routes.concat(t)},recognize:function(t){var e,r,n=t.indexOf("?"),a=t;return-1!==n&&(a=t.substring(0,n),e=Arg.parse(t)),r=this.router.recognize(a),r&&(r=o.extend({},r),r.params=o.extend(r.params,e)),r},generate:function(t,e){return this.router.generate(t,o.extend({},e))},trigger:function(t,e){return n.getRouteHandler(t).call(this.app,e)}};var m=0;n.FilterManager=a=function(t){this.filters=[],this.app=t},n.FilterManager.prototype={add:function(t){this.filters=this.filters.concat(t)},remove:function(t){var e=o.indexOf(this.filters,t);e!==!1&&(m>e&&(m-=1),this.filters.splice(e,1))},process:function(t){var e,r;for(m=0;this.filters.length>m;m++)e=this.filters[m],r=n.getFilterHandler(e).call(this.app,t),r&&(t=r)}},n.setFilterHandler("RouterFilter",function(t){return!t.destination||!t.params,t.destination&&(t=o.extend(t,this.routeManager.trigger(t.destination,t))),t});var y=[];n.setFilterHandler("EventFilter",function(t){return t.partial||r(y),y=y.concat(e(t.events)),t})})(this);