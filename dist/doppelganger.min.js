/***************
 * Doppelganger
 * Copyright Atlassian 2014
 * Released under the Apache 2 license. http://www.apache.org/licenses/LICENSE-2.0.html
 */
(function(e){"use strict";function t(e){var t=[];return e?(o.each(e,function(e,r){var n,a=r.split(" "),i=a[0].split(","),s=a.slice(1).join(" "),u=e;o.each(i,function(r){"statechange"===r?(n=window,e=function(){var e=History.getState().data.query;u(e)},o.addEvent(n,r,e)):(n=l,o.addEvent(n,r,s,e)),t.push({name:r,selector:s,callback:e,elem:n})})}),t):t}function r(e){0!==e.length&&o.each(e,function(e){o.removeEvent(e.elem,e.name,e.selector,e.callback)})}var n;n=function(){this.routes={},this.filters={}},"object"==typeof module&&"object"==typeof module.exports?module.exports=n:e.Doppelganger=n;var a,i,o,s,l=e.document||{},u=Array.prototype,c=u.slice,f=u.isArray,h=u.forEach,d=u.indexOf,g={};n.util=o={getterSetterCreator:function(e){return function(t,r){var n=this[e];return r?(n[t]=r,void 0):n[t]}},extend:function(e){var t,r,n,a=c.call(arguments,1);for(r=0;a.length>r;r++)if(t=a[r])for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},each:function(e,t,r){if(null!=e)if(h&&e.forEach===h)e.forEach(t,r);else if(e.length===+e.length){for(var n=0,a=e.length;a>n;n++)if(t.call(r,e[n],n,e)===!1)return}else for(var i in e)if(e.hasOwnProperty(i)&&t(e[i],i,e)===!1)break},isArray:f||function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&"[object Array]"==""+e||!1},isThenable:function(e){var t=!1;return e&&e.then&&"function"==typeof e.then&&(t=!0),t},indexOf:function(e,t){if(null==e)return-1;var r=0,n=e.length;if(d&&e.indexOf===d)return e.indexOf(t);for(;n>r;r++)if(e[r]===t)return r;return-1},map:function(e,t){var r=-1,n=e?e.length:0,a=Array("number"==typeof n?n:0);if(o.isArray(e))for(;n>++r;)a[r]=t(e[r],r,e);else o.each(e,function(e,n,i){a[++r]=t(e,n,i)});return a},$:function(e){return l.querySelectorAll(e)},matchesSelector:function(e,t){var r,n;if(e.matches)return e.matches(t);if(!e.parentNode){if(e===l)return"document"===t;r=l.createDocumentFragment(),r.appendChild(e)}n=e.parentNode.querySelectorAll(t);for(var a=0,i=n.length;i>a;a++)if(n[a]===e)return!0;return!1},closest:function(e,t){for(var r=e,n=!1;null!=r&&!(n=o.matchesSelector(r,t));)r=r.parentNode;return n},addEvent:function(e,t,r,n){var a=n;if(n=n?function(e){var t=e.target||e.srcElement;o.closest(t,r)&&a.apply(this,arguments)}:r,e.addEventListener)e.addEventListener(t,n,!1);else{if(!e.attachEvent)throw Error("addEvent() was called in a context without event listener support");e.attachEvent("on"+t,n)}g[t]||(g[t]=[]),g[t].push({fn:a,boundFn:n,selector:"string"==typeof r?r:""})},removeEvent:function(e,t,r,n){for(var a,i,o=g[t],s=o?o.length:0,l=0;s>l;l++)if(a=o[l],n===a.fn&&r===a.selector){i=a.boundFn,o.splice(l,1);break}if(i)if(e.removeEventListener)e.removeEventListener(t,i);else{if(!e.detachEvent)throw Error("removeEvent() was called in a context without event listener support");e.detachEvent(t,i)}}},s=o.$;var p={rootUrl:"",routes:[{name:"index",url:""}],filters:["RouterFilter","EventFilter"]},v={routes:"routeManager",filters:"filterManager"};n.create=function(e){var t,r,a=new n;a.options=o.extend({},p,e),a.filterManager=new n.FilterManager(a),a.routeManager=new n.RouteManager(a,a.options.rootUrl);for(var i in v)v.hasOwnProperty(i)&&(t=v[i],r=a.options[i],a[t].add(r));return a.options.urlCoerceMode===!1&&(Arg.coerceMode=!1),a},n.prototype={init:function(){var e=this;this.active=!0,History.Adapter.bind(window,"statechange",function(){var t=History.getState();e.active&&!t.data.controllerStateChange&&(t.data.destination?e.trigger(t.data.destination,t.data.params):t.data.destination||e.trigger(e.startPage.destination,e.startPage.params))}),this.startPage=this.routeManager.recognize(window.location.pathname+window.location.search),this.navigate()},_destroy:function(){this.active=!1},navigate:function(){this.navigate=function(e,t){t.replace?(delete t.replace,this._replace(e,t)):this._push(e,t)},this.startPage?this.trigger(this.startPage.destination,this.startPage.params):this.navigateDefault()},navigateDefault:function(){var e=this.options.defaultRoute[0],t=this.options.defaultRoute[1];this._replace(e,t)},trigger:function(e,t){this.filterManager.process({destination:e,params:t})},updateContent:function(e){var t=s(this.PAGE_CONTENT_SELECTOR);return t.append(e)},_push:function(t,r){history.pushState?History.pushState({destination:t,params:r},l.title,this.routeManager.generate(t,r)):e.location=this.routeManager.generate(t,r)},_replace:function(t,r){history.replaceState?History.replaceState({destination:t,params:r},l.title,this.routeManager.generate(t,r)):e.location=this.routeManager.generate(t,r)}},n.RouteHandlers={},n.setRouteHandler=o.getterSetterCreator("RouteHandlers"),n.getRouteHandler=o.getterSetterCreator("RouteHandlers"),n.FilterHandlers={},n.setFilterHandler=o.getterSetterCreator("FilterHandlers"),n.getFilterHandler=o.getterSetterCreator("FilterHandlers"),n.RouteManager=i=function(e,t){this.app=e,this.router=new Sherpa.Router,this.baseUrl=t,this.routes=[]},n.RouteManager.prototype={add:function(e){for(var t,r,n,a=e.length,i=0;a>i;i++)t=e[i],r=t.name,n=t.url,this.router.add(this.baseUrl+n,t).to(r).name(r);this.routes=this.routes.concat(e)},recognize:function(e){var t,r,n=e.indexOf("?"),a=e;return-1!==n&&(a=e.substring(0,n),t=Arg.parse(e)),r=this.router.recognize(a),r&&(r=o.extend({},r),r.params=o.extend(r.params,t)),r},generate:function(e,t){return this.router.generate(e,o.extend({},t))},trigger:function(e,t){return n.getRouteHandler(e).call(this.app,t)}};var m=0;n.FilterManager=a=function(e){this.filters=[],this.app=e},n.FilterManager.prototype={add:function(e){this.filters=this.filters.concat(e)},remove:function(e){var t=o.indexOf(this.filters,e);t!==!1&&(m>=t&&(m-=1),this.filters.splice(t,1))},process:function(e,t){var r,a,i=this;for(m=t||0;this.filters.length>m&&(r=this.filters[m],a=n.getFilterHandler(r).call(this.app,e),!o.isThenable(a));m++)e=a||e;m!==this.filters.length&&o.isThenable(a)&&a.then(function(t){e=t||e,i.process(e,m+1)})}},n.setFilterHandler("RouterFilter",function(e){return!e.destination||!e.params,e.destination&&(e=o.extend(e,this.routeManager.trigger(e.destination,e))),e});var y=[];n.setFilterHandler("EventFilter",function(e){return e.partial||r(y),y=y.concat(t(e.events)),e})})(this);