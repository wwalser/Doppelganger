(function(e){"use strict";function t(e){var t=[];return e?(o.each(e,function(e,r){var n,a=r.split(" "),i=a[0].split(","),s=a.slice(1).join(" "),l=e;o.each(i,function(r){"statechange"===r?(n=window,e=function(){var e=History.getState().data.query;l(e)},o.addEvent(n,r,e)):(n=d,o.addEvent(n,r,s,e)),t.push({name:r,selector:s,callback:e,elem:n})})}),t):t}function r(e){0!==e.length&&o.each(e,function(e){o.removeEvent(e.elem,e.name,e.selector,e.callback)})}var n;n=function(){this.routes={},this.filters={}},"object"==typeof module&&"object"==typeof module.exports?module.exports=n:e.Doppelganger=n;var a,i,o,s,l=Array.prototype,u=l.slice,c=l.isArray,f=l.forEach,h=l.indexOf,d=e.document||{},g=e.Sherpa||{Router:function(){}},p=e.Arg||{all:function(){}},v={};n.util=o={getterSetterCreator:function(e){return function(t,r){var n=this[e];if("string"!=typeof t)o.isArray(n)?o.isArray(t)?l.push.apply(n,t):n.push(t):o.extend(n,t);else{if(!r)return n[t];n[t]=r}}},extend:function(e){var t,r,n,a=u.call(arguments,1);for(r=0;a.length>r;r++)if(t=a[r])for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},each:function(e,t,r){if(null!=e)if(f&&e.forEach===f)e.forEach(t,r);else if(e.length===+e.length){for(var n=0,a=e.length;a>n;n++)if(t.call(r,e[n],n,e)===!1)return}else for(var i in e)if(e.hasOwnProperty(i)&&t(e[i],i,e)===!1)break},isArray:c||function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&"[object Array]"==""+e||!1},indexOf:function(e,t){if(null==e)return-1;var r=0,n=e.length;if(h&&e.indexOf===h)return e.indexOf(t);for(;n>r;r++)if(e[r]===t)return r;return-1},map:function(e,t){var r=-1,n=e?e.length:0,a=Array("number"==typeof n?n:0);if(o.isArray(e))for(;n>++r;)a[r]=t(e[r],r,e);else o.each(e,function(e,n,i){a[++r]=t(e,n,i)});return a},$:function(e){return d.querySelectorAll(e)},matchesSelector:function(e,t){var r,n;if(e.matches)return e.matches(t);if(!e.parentNode){if(e===d)return"document"===t;r=d.createDocumentFragment(),r.appendChild(e)}n=e.parentNode.querySelectorAll(t);for(var a=0,i=n.length;i>a;a++)if(n[a]===e)return!0;return!1},closest:function(e,t){for(var r=e,n=!1;null!=r&&!(n=o.matchesSelector(r,t));)r=r.parentNode;return n},addEvent:function(e,t,r,n){var a=n;if(n=n?function(e){var t=e.target||e.srcElement;o.closest(t,r)&&a.apply(this,arguments)}:r,e.addEventListener)e.addEventListener(t,n,!1);else{if(!e.attachEvent)throw Error("addEvent() was called in a context without event listener support");e.attachEvent("on"+t,n)}v[t]||(v[t]=[]),v[t].push({fn:a,boundFn:n,selector:"string"==typeof r?r:""})},removeEvent:function(e,t,r,n){for(var a,i,o=v[t],s=o?o.length:0,l=0;s>l;l++)if(a=o[l],n===a.fn&&r===a.selector){i=a.boundFn,o.splice(l,1);break}if(i)if(e.removeEventListener)e.removeEventListener(t,i);else{if(!e.detachEvent)throw Error("removeEvent() was called in a context without event listener support");e.detachEvent(t,i)}}},s=o.$;var m={routes:{index:""},filters:["EventFilter","RouterFilter"]},y={routes:"routeManager",filters:"filterManager"};n.create=function(e){var t,r,a=new n;a.options=o.extend({},m,e.options),a.filterManager=new n.FilterManager(a),a.routeManager=new n.RouteManager(a,e.rootUrl);for(var i in y)y.hasOwnProperty(i)&&(t=y[i],r=e[i]||a.options[i],a[t].add(r));return a},n.prototype={init:function(){var e=this;History.Adapter.bind(window,"statechange",function(){var t=History.getState();t.data&&t.data.controllerStateChange||e.trigger(t.data.destination,t.data.params)}),this.startPage=this.routeManager.recognize(window.location.pathname),this.navigate()},navigate:function(){this.navigate=function(t,r){history.pushState?History.pushState({destination:t,params:r},d.title,this.routeManager.generate(t,r)):e.location=e.helpers.routing.generate(t,r)},this.startPage?(this.startPage=o.extend({},this.startPage),this.startPage.params=o.extend(this.startPage.params,p.all()),this.filterManager.process(this.startPage)):this.navigate(this.options.defaultRoute[0],this.options.defaultRoute[1])},trigger:function(e,t){this.filterManager.process({destination:e,params:t})},updateContent:function(e){var t=s(this.PAGE_CONTENT_SELECTOR);return t.append(e)}},n.RouteHandlers={},n.setRouteHandler=o.getterSetterCreator("RouteHandlers"),n.getRouteHandler=o.getterSetterCreator("RouteHandlers"),n.FilterHandlers={},n.setFilterHandler=o.getterSetterCreator("FilterHandlers"),n.getFilterHandler=o.getterSetterCreator("FilterHandlers"),n.RouteManager=i=function(e,t){this.app=e,this.router=new g.Router,this.baseUrl=t,this.routes={}},n.RouteManager.prototype={add:function(e){for(var t,r,n,a=e.length,i=0;a>i;i++)t=e[i],r=t.name,n=t.url,this.router.add(this.baseUrl+n,t).to(r).name(r);o.extend(this.router,t)},get:o.getterSetterCreator("routes"),recognize:function(e){return this.router.recognize(e)},generate:function(e,t){return this.router.generate(e,o.extend({},t))},trigger:function(e,t){return n.getRouteHandler(e).call(this.app,t)}};var E=0;n.FilterManager=a=function(e){this.filters=[],this.app=e},n.FilterManager.prototype={add:o.getterSetterCreator("filters"),remove:function(e){var t=o.indexOf(e,this.filters);t!==!1&&(E>t&&(E-=1),this.filters.splice(t,1))},process:function(e){for(E=0;this.filters.length>E;E++){var t=this.filters[E];e=n.getFilterHandler(t).call(this.app,e)}}},n.setFilterHandler("RouterFilter",function(e){return!e.destination||!e.params,e.destination&&(e=o.extend(e,this.routeManager.trigger(e.destination,e))),e});var w=[];n.setFilterHandler("EventFilter",function(e){return e.partial||r(w),w=w.concat(t(e.events)),e})})(this);